---
title: Vue3实战难点
date: 2023-04-27 10:26:30
permalink: /pages/f4c038/
categories:
  - 技术
tags:
  - Vue3实战
---
## 在线预览Word

### word安装

- `npm i --save docx-preview@0.1.4`
- `npm i --save jszip@3.10.1`

### pdf安装

- `npm i --save pdfjs-dist@2.0.943`

### 使用

```js
<!-- 预览报告模板 -->
  <a-modal class="file-modal" v-model:visible="visibleFile" title="文件预览" :width="900" @ok="visibleFile = false">
    <template slot="footer">
        <a-button @click="visibleFile = false">确定</a-button>
    </template>
    <div ref="file"></div>
  </a-modal>

  <!-- 预览文件 -->
  <a-modal class="file-modal" v-model:visible="isShow" title="文件预览" :width="900" @ok="isShow = false">
    <template slot="footer">
        <a-button @click="isShow = false">确定</a-button>
    </template>
    <div ref="showFile" v-if="fileType == 'doc'"></div>
    <img :src="fileUrl" alt="" v-if="fileType == 'jpg'" class="fileUrl">
    <div id="printDom" ref="printDom" v-if="fileType == 'pdf'">
        <div v-for="item in state.numPages" :key="item">
            <canvas :id="`pdfCanvas-${item}`" :ref="`pdfCanvas-${item}`" />
        </div>
    </div>
  </a-modal>

// word
import axios from 'axios';
const docx = require('docx-preview');
window.JSZip = require('jszip')
// pdf
import * as pdfjsLib from 'pdfjs-dist'

// 预览总结报告模板
const showFileModal = (url) => {
  // 显示Word
  if (url.includes('.doc') || url.includes('.docx')) {
    visibleFile.value = true;
    axios({
        method: 'get',
        responseType: 'blob', // 设置响应文件格式
        url: url
    }).then(({ data }) => {
        docx.renderAsync(data, proxy.$refs.file) // 渲染到页面预览
    })
  } 
  // 显示PDF
  if(url.includes('pdf')) {
    showFile.isShow = true
    showFile.fileUrl = url
    showFile.fileType = 'pdf'

    pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.js'
    const loadingTask = pdfjsLib.getDocument({
        url: url,  //这里的pdfUrl即pdf的链接地址
        cMapUrl: '../../../../static/cmaps/',
        cMapPacked: true
    })
    loadingTask.promise.then(pdf => {
        // console.log('页数', pdf.numPages)
        state.numPages = pdf.numPages
        state.pdfCtx = pdf
        nextTick(() => {
            renderPdf()
        })
    })
  }
}

// 预览滚动样式
.file-modal {
  /deep/ .ant-modal {
    .ant-modal-body {
      max-height: calc(90vh - 150px);
      overflow-y: auto;
      &::-webkit-scrollbar {
        width: 6px;
        /*高宽分别对应横竖滚动条的尺寸*/
        height: 1px;
      }
    
      &::-webkit-scrollbar-thumb {
        background: #e3e3e6;
        border-radius: 6px;
      }
    
      &::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 5px;
      }
    }
  }
  canvas {
    max-width: 850px !important;
  }
}
```



## 下载在线文档

- 本接口以word为例，接口以流的方式返回
- 需要对请求接口进行处理，对接口返回的响应头`content-disposition`进行处理
- 安装`npm i file-saver -S`

```js
// http.js
import request from '@/api/request'
import {encodeUrlParams} from "@/utils/utils";
const http = {
    get(url, params) {
        const config = {
            method: 'get',
            url: url
        } /*这里如果GET请求有参数，则携带上传入的参数，在
            URL中以？的方式放在请求链接中*/
        if (params) {
          if (params.page && Number.isSafeInteger(params.page) && params.page > 0) {
            params.pageNo = params.page;
            delete params.page;
          }
          encodeUrlParams(params);
          config.params = params
        }
        return request(config)
    },
    post(url, params) {
        const config = {
            method: 'post',
            url: url
        }/*同理也是传入用户需要发送到后台的参数，这些参数
            放在报文中，载体表达标准是JSON*/
        if (params) config.data = params
        return request(config)
    },
  postOf(url, params) {
    const config = {
      method: 'post',
      url: url,
      responseType: 'blob'
    }/*同理也是传入用户需要发送到后台的参数，这些参数
            放在报文中，载体表达标准是JSON*/
    if (params) config.data = params
    return request(config)
  },
    put(url, params) {
        const config = {
            method: 'put',
            url: url
        }/*同理也是传入用户需要发送到后台的参数，这些参数
            放在报文中，载体表达标准是JSON*/
        if (params) config.data = params
        return request(config)
    },
    del(url, params) {
        const config = {
            method: 'delete',
            url: url
        }/*这里如果DELETE请求有参数，则携带上传入的参数，在
            URL中以？的方式放在请求链接中*/
        if (params) config.params = params
        return request(config)
    },
}

//暴露接口，允许Vue文件或其他js,ts文件使用http结构体中的方法
export default http
```

```js
// requeset.js
import axios from 'axios';
import { message } from 'ant-design-vue';
import { removeStorage } from "@/utils/localStorage";
import store from '@/store/store'
// 创建一个自定义的Axios对象
const Axios = axios.create({
    baseURL: process.env.NODE_ENV === 'development' ? '/' : process.env.VUE_APP_API_HOST,
    timeout: 1000*30,
    /*也可以不设置Content-Type，影响是在你发送请求时
    Vue会先发送OPTIONS包探测路由是否存在，需要后端也做设置响应OPTIONS
    方法，否则会报跨域错误；我这里用的Beego2，路由里不响应OPTIONS方法，
    所以我在这块设置Content-Type*/
    // headers: {
    //     'Content-Type': 'application/x-www-form-urlencoded',
    // },
    /*这个配置很重要，允许axios携带用户Cookie到后端，不设置这个的话
    Set-Cookie是无效的,除此之外,Chrome默认开启了SameSite检查，如果
    后端不主动设置SameSite = none,Set-Cookie是无效的。*/
    // withCredentials: true
});
Axios.interceptors.request.use(req => {
    const token = sessionStorage.getItem('accessToken')
    if (token) {
        req.headers['X-Access-Token'] = token // 让每个请求携带自定义 token 请根据实际情况自行修改
    }
    // 请求拦截处理
    // console.log('这里是请求拦截器，我拦截了请求', req);
    return req;
}, err => {
    console.log('在发送请求时发生错误，错误为', err);
    //这里不能直接放回err,需要按照官方说明返回一个Promise
    return Promise.reject(err);
})
Axios.interceptors.response.use(res => {
    //token是否超过有效期
    let tokens = JSON.parse(sessionStorage.getItem('tokenTimes'))
    if(tokens&&tokens.termOfValidity){
        let nowTime = new Date();
        // console.log("得很好：",parseInt(nowTime-new Date(tokens.currentTime))/1000/60)
        // console.log("得很好：",new Date(tokens.currentTime))
        let timeDiff = parseInt(nowTime-new Date(tokens.currentTime))/1000/60;
        if(Math.ceil(timeDiff)>9){
            // console.log("需要刷新token了")
        }
    }
    // 获取文件名
    if(res.headers['content-disposition'])res.data['content-disposition'] = res.headers['content-disposition']
    // 响应拦截处理
    return res.data;
}, error => {
    const err = error.toString();
    //按照实际的响应包进行解析，通过关键字匹配的方式
    if (error.response?.message === 'Token失效，请重新登录'||error.response?.data.message === 'Token失效，请重新登录') {
        if (store.state.errIndex === 0) {
            message.error('很抱歉，登录已过期，请重新登录')
            store.commit('SET_ERR_INDEX', 1)
        }
        removeStorage();
        setTimeout(() => { 
            window.location.replace(process.env.VUE_APP_API_HOST2);
            window.name="'一体化平台'"
        }, 1500)
        return;
    }
    // switch (true) {
    //     case err.indexOf('Network') !== -1:
    //         console.log('后端服务器无响应或者URL错误', err);
    //         message.error('后端服务器无响应或者URL错误');
    //         break;
    //     case err.indexOf('timeout') !== -1:
    //         console.log('请求后端服务器超时！', err);
    //         message.error('请求后端服务器超时！');
    //         break;
    //     default:
    //         message.error(error.response.data.message||'接口请求出错！');
    //         break
    // }
    if(error.message.indexOf('Network') !== -1) {
        console.log('后端服务器无响应或者URL错误', err);
        message.error('后端服务器无响应或者URL错误');
    }else if (error.message.indexOf('timeout') !== -1) {
        console.log('请求后端服务器超时！', err);
        message.error('请求后端服务器超时！');
    }else {
        message.error(error.response?.data.message||'接口请求出错！');
    }
    return Promise.reject(error);
})
//暴露Axios实例化对象，允许所有文件调用Axios
export default Axios;
```

```js
import FileSaver from 'file-saver'

const exportDayReportFn = () => {
    exportDayReport({
        reportDate: dayjs(searchDate.value).format(dateFormat),
        sysOrgCode: sysOrgCode.value,
    }).then((res) => {
        let name = res['content-disposition'] ? decodeURIComponent(res['content-disposition'].split('=')[1].replace(/"/g,'')) : '无文件名'
        const blob = new Blob([res], { type: "application/octet-stream" });
        FileSaver.saveAs(blob, `${name}.docx`);
    }).catch((err) => {
        console.error(err);
    })
}
```

**主要是这里的配置**

```js
postOf(url, params) {
    const config = {
      method: 'post',
      url: url,
      responseType: 'blob'
    }/*同理也是传入用户需要发送到后台的参数，这些参数
            放在报文中，载体表达标准是JSON*/
    if (params) config.data = params
    return request(config)
}
  
 Axios.interceptors.response.use(res => {
    //token是否超过有效期
    let tokens = JSON.parse(sessionStorage.getItem('tokenTimes'))
    if(tokens&&tokens.termOfValidity){
        let nowTime = new Date();
        // console.log("得很好：",parseInt(nowTime-new Date(tokens.currentTime))/1000/60)
        // console.log("得很好：",new Date(tokens.currentTime))
        let timeDiff = parseInt(nowTime-new Date(tokens.currentTime))/1000/60;
        if(Math.ceil(timeDiff)>9){
            // console.log("需要刷新token了")
        }
    }
    // 获取文件名
    if(res.headers['content-disposition'])res.data['content-disposition'] = res.headers['content-disposition']
    // 响应拦截处理
    return res.data;
},error => {})

// 通过这个方法进行下载
FileSaver.saveAs(blob, `${name}.docx`);
```



## 预览图片水印

```js
<!-- 预览图片水印功能 -->
<div v-if="picVisible" class="pic-Modal" id="pic-Modal" @click="closePicModal" @mousewheel.prevent="handerPictu">
  <div id="pic-wrap"></div>
  <img ref="oImg" :src="picUrl" :style="{ width: picWidth, height: picHeight, zIndex: -1 }" alt=""/>
  <canvas id="picCanvas" />
</div>

<div class="pic-box">
    <a-image
      :src="item.filePath"
      :preview="false"
    />
    <div class="pic-content" @click="() => addWaterMark(true , index , item.filePath)" >
      <img src="@/assets/images/template/preview-default.png">
      <span>预览</span>
    </div>
</div>
  
  
// 现场情况图片预览水印
let picVisible = ref(false)
let imgCanvans = ''
let picCanvas = ''
let picIndex = ref(0)
let picUrl = ref('')
const addWaterMark = (value , index, url) => {
  picVisible.value = value;
  picUrl.value = url
  if (typeof index === 'number') {
    picIndex.value = index
  }
  if (picVisible.value) {
    nextTick(()=> {
      document.getElementById('pic-Modal').style.width = document.body.clientWidth + 'px'
      document.getElementById('pic-Modal').style.height = document.body.clientHeight + 'px'
      document.body.parentNode.style.overflow = 'hidden'

      imgCanvans = document.getElementById('pic-wrap')
      picCanvas = document.getElementById('picCanvas')
      picCanvas.width = 600
      picCanvas.height = 200

      picCanvas.style.display = 'none'
      const ctx = picCanvas.getContext('2d')
      ctx.font = '16px Microsoft JhengHei'
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'
      ctx.rotate(-0.35)
      ctx.fillText(`${dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss')}       ${store.state.userInfo.realname}`, 125, picCanvas.height / 1)
      ctx.fillText(`协同调度系统`, 0 , picCanvas.height / 1)

      const img = picCanvas.toDataURL('image/png')
      const style = `background-image:url(${img})`
      imgCanvans.setAttribute('style', style)
    })
  } else {
    imgCanvans.style.display = 'none'
  }
}

// 预览图片resize监听
const picChangeResize = () => {
  if (picVisible.value) {
    document.getElementById('pic-Modal').style.width = document.body.clientWidth + 'px'
    document.getElementById('pic-Modal').style.height = document.body.clientHeight + 'px'
  }
}

// 预览图片放大缩小图片
let picWidth = ref('fit-content')
let picHeight = ref('fit-content')
const handerPictu = (e) => {
  let transforms = proxy.$refs.oImg.style.transform
  let zoom = transforms.indexOf("scale") != -1 ? +transforms.split("(")[1].split(")")[0] : 1
  zoom += e.wheelDelta / 1200
  if (zoom > 0.1 && zoom < 2) {
    proxy.$refs.oImg.style.transform = "scale(" + zoom + ")"
  }
}

const closePicModal = () => {
  picVisible.value = false
  document.body.parentNode.style.overflow = 'auto'
  picWidth.value = 'fit-content'
  picHeight.value  = 'fit-content'
}

onMounted(()=>{
  window.addEventListener("resize", picChangeResize)
});

onUnmounted(()=> {
    window.removeEventListener('resize', picChangeResize)
})

return{
  // 图片预览水印
  picVisible,
  picIndex,
  addWaterMark,
  closePicModal,
  handerPictu,
  picWidth,
  picHeight,
  picUrl,
}

// 图片水印
.pic-scene-box {
  width: 100%;
  height: 100%;
  /deep/ .ant-image {
    width: 100%;
    height: 100%;
    img {
      width: 100%;
      height: 100%;
    }
  }
}
.pic-box {
  position: relative;
 &:hover {
    cursor: pointer;
 }
 &:hover .pic-content {
  display: flex;
  justify-content: center;
  align-items: center;
  position: absolute;
  top: 0;
  left: 0;
  background-color: rgba(127,127,127,0.5);
  z-index: 9999;
  width: 100%;
  height: 100%;
  color: #fff;
  img {
    width: 26px;
    height: 26px;
    margin-right: 5px;
  }
 }
}
.pic-content {
  display: none;
  width: 100%;
  height: 100%;
}
.pic-Modal {
  position: fixed;
  top: 0;
  left: 0;
  background-color: rgba(0, 0, 0, 0.45);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  #pic-wrap {
    width: 100%;
    height: 100%;
    position: fixed;
    top: 0;
    left: 0;
  }
  img {
    min-width: 30px !important;
    min-height: 30px !important;
    max-width: 1240px !important;
    max-height: 1240px !important;
  }
}
```



## 预览视频水印

- `npm i vue3-video-play` (1.3.1-beta.6)

```js
<!-- 预览视频水印Canvas -->
<canvas id="videoCanvans"></canvas>

<template v-for="(item,index) in globalData.eventDetailsObj.videoAttachment" :key="item.id">
    <!-- 视频预览水印 -->
    <div class="fileItem" v-if="globalData.sceneTypeTabKey == 0 || globalData.sceneTypeTabKey == 2 || (globalData.sceneTypeTabKey == 4 && item.resourceType == 1)">
        <video-play
          v-bind="options" 
          :src="item.filePath"
          @play="onPlay(index)"
        />
    </div>
</template>

<!-- 视频 -->
<div v-else-if="ele.videoUrl" class="videoBox">
    <video-play
      v-bind="options" 
      :src="ele.videoUrl"
      @play="onPlaySend(ele.videoTotal)"
    />
</div>

import { videoPlay } from 'vue3-video-play'
components: {
	videoPlay,
}
    
const options = reactive({
  width: '100%', //播放器高度
  height: '100%', //播放器高度
  // color: "#409eff", //主题色
  muted: false, //静音
  webFullScreen: false,
  speedRate: ["0.75", "1.0", "1.25", "1.5", "2.0"], //播放倍速
  autoPlay: false, //自动播放
  loop: false, //循环播放
  mirror: false, //镜像画面
  ligthOff: false,  //关灯模式
  volume: 0.3, //默认音量大小
  control: true, //是否显示控制器
  controlBtns: [
    "audioTrack",
    "quality",
    "speedRate",
    "volume",
    "setting",
    "fullScreen",
  ], //显示所有按钮,
  title: '', //视频名称
  // src: "http://vjs.zencdn.net/v/oceans.mp4", //视频源
  poster: '', //封面
})

// 监听视频是否处于全屏状态并设置当前水印时间
let nowDate = ''
let videoActiveIndex = ref('')
const checkIsFullScreen = () => {
    var isFullScreen = document.fullscreen || document.mozFullScreen || document.webkitIsFullScreen;
    return isFullScreen == undefined ? false : isFullScreen;
}
const fullScreenChange = () => {
  if (checkIsFullScreen()) {
      console.log("进入全屏");
      nowDate = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss')
      if (videoActiveIndex.value !== '') {
        document.querySelectorAll('.d-player-control')[videoActiveIndex.value].style.setProperty('height', '50px', 'important');
      }

      // 获取所有类名为 top-title 的 p 元素
      const pElements = document.querySelectorAll('p.top-title');
      if (pElements.length !== 0) {
        // 遍历 p 元素列表，并移除类名为 top-title 的元素
        pElements.forEach((pElement) => {
          pElement.remove()
        });
      }
  } else {
      console.log("退出全屏");
      if (videoActiveIndex.value !== '') {
        document.querySelectorAll('.d-player-control')[videoActiveIndex.value].style.setProperty('height', '30px', 'important');
      }
  }
}

// 视频预览水印
const onPlay = (index) => {
    if (!nowDate) {
      nowDate = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss')
    }

    imgCanvans = document.getElementsByClassName('d-player-state')[index]
    picCanvas = document.getElementById('videoCanvans')
    picCanvas.width = 600
    picCanvas.height = 200

    picCanvas.style.display = 'none'
    const ctx = picCanvas.getContext('2d')
    ctx.font = '16px Microsoft JhengHei'
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'
    ctx.rotate(-0.35)
    ctx.fillText(`${nowDate}       ${store.state.userInfo.realname}`, 125, picCanvas.height / 1)
    ctx.fillText(`协同调度系统`, 0 , picCanvas.height / 1)

    const img = picCanvas.toDataURL('image/png')
    const style = `background-image:url(${img})`
    imgCanvans.setAttribute('style', style)
}

// 协同处置视频预览水印
let videoTotal = ref(0)
const onPlaySend = (videoTotal) => {
    videoActiveIndex.value = videoTotal
    if (!nowDate) {
      nowDate = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss')
    }

    imgCanvans = document.getElementsByClassName('d-player-state')[videoTotal]
    picCanvas = document.getElementById('videoCanvans')
    picCanvas.width = 600
    picCanvas.height = 200

    picCanvas.style.display = 'none'
    const ctx = picCanvas.getContext('2d')
    ctx.font = '16px Microsoft JhengHei'
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'
    ctx.rotate(-0.35)
    ctx.fillText(`${nowDate}       ${store.state.userInfo.realname}`, 125, picCanvas.height / 1)
    ctx.fillText(`协同调度系统`, 0 , picCanvas.height / 1)

    const img = picCanvas.toDataURL('image/png')
    const style = `background-image:url(${img})`
    imgCanvans.setAttribute('style', style)
}

onMounted(()=>{
  window.addEventListener('fullscreenchange', fullScreenChange)
});

onUnmounted(()=> {
  window.removeEventListener('fullscreenchange', fullScreenChange)
})
    
return{
  // 视频预览水印
  options,
  onPlay,
  onPlaySend,
  info,
  isLoading,
  isAlreadyEventType,
  eventDetailsLoadings,
  isActivated,
  debounce2,
}
```



## 内嵌非菜单tab

```js
import Layout from '@/views/layout'

export default {
    path: '/amc/order-mgt',
    component: Layout,
    redirect: '/amc/order-mgt/order-list',
    name: 'AmcOrderMgt',
    meta: {
        title: '订单管理',
        icon: 'supplier-goods-mgt',
        onBar: false // onBar控制是否显示出来
    },
    children: [
        {
            path: 'order-list',
            name: 'AmcOrderList',
            component: () => import('@/views/amc/order-mgt/order-list.vue'),
            meta: { title: '订单管理' }
        },
        {
            path: 'order-detail',
            name: 'AmcOrderDetail',
            component: () => import('@/views/amc/order-mgt/order-detail.vue'),
            hidden: true,
            meta: {
                title: '订单详情',
                insertRoute: {
                    name: 'AmcOrderList',
                    path: '/amc/order-mgt/order-list',
                    meta: { title: '订单管理' }
                }
            }
        },
        {
            path: 'aftersale-list-v2',
            name: 'AmcAftersaleListV2',
            component: () =>
                import('@/views/amc/order-mgt/aftersale-list-v2.vue'),
            meta: { title: '售后管理' }
        },
        {
            path: 'aftersale-detail-v2',
            name: 'AmcAftersaleDetailV2',
            component: () =>
                import('@/views/amc/order-mgt/aftersale-detail-v2.vue'),
            hidden: true,
            meta: {
                title: '售后详情',
                insertRoute: {
                    name: 'AmcAftersaleListV2',
                    path: '/omc/order-mgt/aftersale-list-v2',
                    meta: { title: '售后管理' }
                }
            }
        }
    ]
}
```



## 动态KeepAlive

- 解决keepAlive关闭tab页面再次打开依旧有缓存问题
- 以include的方式动态进行缓存

```js
<router-view 
    v-slot="{ Component }" 
    :class="{
        'right-box': !collapseds && indexObj.isSideMenuShow.bool == true,
        'right-box right-box2': (collapseds && indexObj.isSideMenuShow.bool == true) || isReload,
        'other-box3': routerName === 'home',
        'other-box5': routerName === 'eventDetails2',
      }">
    <keep-alive :include="$store.state.keepAlive">
      <component :is="Component"/>
    </keep-alive>
</router-view>

// store.js
const store = createStore({
	state: {
		keepAlive: ['roadOverviewNew'],
	},
	mutations: {
		SET_KEEPALIVE(state,obj){
            state.keepAlive = obj
        },
        REMOVE_KEEPALIVE(state,obj){
            const index = state.keepAlive.indexOf(obj[0])
            index > -1 && state.keepAlive.splice(index, 1)
        },
        ADD_KEEPALIVE(state,obj){
            state.keepAlive.push(obj[0])
        }
	}
})

// permisson.js 每次打开需要重新初始化
store.commit("SET_KEEPALIVE", ['roadOverviewNew'])

// utils.js
// 缓存菜单路由数据
export const menuObj = {
    '通知对象管理': 'tbNoticeChannelInfo',
    '事件评价项目管理': 'tbEventEvaluateProject',
    '事件类型管理': 'tbEventCategory',
    '事件评价标签管理': 'tbEventEvaluateLabel',
    '处置模型管理': 'tbDisposalModelV2',
    '值班人员管理': 'operator',
    '班次规则设置': 'electronicFence',
    '我的消息': 'MyMessage',
    '日常工作总结': 'dailyWorkReport',
    '事件信息': 'eventInformation2',
    '事件信息统计': 'dataStatistics',
    '人工日月报表': 'DailyMonthWorkReport',
    '处置节点基础信息': 'tbDisposalNodeInfo',
    '评价项目': 'tbEventEvaluateProject',
    '评价标签': 'tbEventEvaluateLabel'
}

// index.vue
import { menuObj } from "@/utils/utils";
const getMenuTabs = (res) => {
  console.log('--点击左菜单--', res)
  // 添加需要缓存的菜单路由
  let list = []
  if (res.meta.title && menuObj.hasOwnProperty(res.meta.title) && res.meta.title !== '路况总览' && !store.state.keepAlive.includes(menuObj[res.meta.title])) {
    list.push(menuObj[res.meta.title])
    store.commit('ADD_KEEPALIVE', list)
    list = []
  } 
}

// GlobalHeader.vue
import { menuObj } from "@/utils/utils";
const tabCloseClick = (item, index) => {
  // 移出需要缓存的菜单路由
  let list = []
  if (item.path && !item.path.includes('eventDetails2') && menuObj.hasOwnProperty(item.meta.title) && item.meta.title !== '路况总览') {
    list.push(menuObj[item.meta.title])
    store.commit('REMOVE_KEEPALIVE', list)
    list = []
  }
}
```



## 高德地图

- `npm i @amap/amap-jsapi-loader -S`（^1.0.1）
- 打点`Marker`
- 点聚合`MarkerClusterer`
- 全局挂载`index.html`：挂载完`window`会自动暴露一个`AMap`变量，之后进行引用即可

> 注意：高德地图不要用响应式数据去存储，响应式数据会造成意想不到的bug

```html
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode:'709c59ab035b7c6f660a8e731d709c99',
    }
</script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.5&key=7420458a9eaeb41505d4e45016e3adb9&plugin=AMap.PolyEditor,AMap.CircleEditor,AMap.MarkerClusterer"></script> 
<script>
```

```js
<!-- 提示 -->
<a-spin :spinning="mapObj.mapLoading" tip="高速公路大脑为您加速">
	<div id="container" class="pa"></div>
</a-spin>
<!-- 人员点聚合信息窗体 -->
<div class="clusterWindowBox" ref="clusterWindowBoxRef" :style="{width:clusterArr.length == 1?'211px':''}">
    <div class="clusterWindowItem" :class="clusterArr.length == 1?'oneCluster':''" v-for="(item,index) in clusterArr" :key="index" >
      <p :title="item.orgName"><span>部门：</span>{{item.orgName}}</p>
      <p :title="item.realName"><span>姓名：</span>{{item.realName}}</p>
      <p :title="item.workStatus_dictText"><span>状态：</span>{{item.workStatus_dictText}}</p>
      <p :title="item.phone"><span>电话：</span>{{item.phone}}</p>
    </div>
</div>
<!-- 事件点聚合信息窗体 -->
<div class="clusterWindowBox" ref="clusterEventWindowBoxRef" :style="{width:clusterEventArr.length == 1?'211px':''}">
    <div class="clusterWindowItem clusterEventWindowItem" :class="clusterEventArr.length == 1?'oneCluster':''" v-for="(item,index) in clusterEventArr" :key="index" @click="toEventDetailsFn(item)">
      <p class="clusterEventWindowItem-name" :title="item.name">{{item.name}}</p>
      <p :title="item.eventTime"><span>事件时间：</span>{{item.eventTime}}</p>
      <p :title="item.categoryName"><span>分类：</span>{{item.categoryName}}</p>
      <p :title="item.chaiageNum"><span>桩号：</span>{{item.chaiageNum}}</p>
      <p :title="item.trafficState"><span>交通状况：</span>{{item.trafficState}}</p>
    </div>
</div>

import AMapLoader from '@amap/amap-jsapi-loader'

let GDMap = null
let personMarkerClusterer = null
let eventMarkerClusterer1 = null
let eventMarkerClusterer2 = null
let eventMarkerClusterer3 = null
let eventMarkerClusterer4 = null
let eventMarkerClusterer5 = null
let accidentMarkerArr1 = []
let accidentMarkerArr2 = []
let accidentMarkerArr3 = []
let accidentMarkerArr4 = []
let accidentMarkerArr5 = []

const clusterInfoWindow = ref(null)
const clusterArr = ref([])
const clusterEventArr = ref([])
const clusterWindowBoxRef = ref(null)
const clusterEventWindowBoxRef = ref(null)

// 地图初始化
const initMap = async () => {
  GDMap = new window.AMap.Map('container', {
    center: [113.338552, 23.076839],
    zoom: 13,
    viewMode: '3D',
    pitch: 60, // 地图俯仰角度，有效范围 0 度- 83 度
    mapStyle: 'amap://styles/whitesmoke',
  })
  GDMap.on('complete', (e) => {
    mapObj.mapLoading = false
    // mapObj.isMapLoaded = true
    // setTimeout(() => {
    getSectionInfoApiFn() //画线路
    queryEventInfoApiFn() //地图加载重大交通事故地点图标位置
    // }, 1000)
  })
  GDMap.on('mousewheel', (e) => {
    if(clusterInfoWindow){
      clusterInfoWindow.close()
      clusterArr.value = []
      clusterEventArr.value = []
      clusterYiGouEventArr.value = []
    }
  })
  GDMap.on('click', (e) => {
  })
}

//地图加载重大交通事故地点图标位置
const accidentMarkerFn = (data) => {
  if(GDMap) {
    GDMap.remove(accidentMarkerArr1)
    GDMap.remove(accidentMarkerArr2)
    GDMap.remove(accidentMarkerArr3)
    GDMap.remove(accidentMarkerArr4)
    GDMap.remove(accidentMarkerArr5)
    accidentMarkerArr1 = []
    accidentMarkerArr2 = []
    accidentMarkerArr3 = []
    accidentMarkerArr4 = []
    accidentMarkerArr5 = []

    // 每次打点都需要清除点聚合对象
    if (eventMarkerClusterer1) {
      GDMap.remove(eventMarkerClusterer1)
      eventMarkerClusterer1 = null
    }
    if (eventMarkerClusterer2) {
      GDMap.remove(eventMarkerClusterer2)
      eventMarkerClusterer2 = null
    }
    if (eventMarkerClusterer3) {
      GDMap.remove(eventMarkerClusterer3)
      eventMarkerClusterer3 = null
    }
    if (eventMarkerClusterer4) {
      GDMap.remove(eventMarkerClusterer4)
      eventMarkerClusterer4 = null
    }
    if (eventMarkerClusterer5) {
      GDMap.remove(eventMarkerClusterer5)
      eventMarkerClusterer5 = null
    }
    // 查找事件数据是否有经纬度相同的点，有则删除
    // data.forEach((targetItem, index) => {
    //   let isHasPoint = data.findIndex((item) => {
    //     if (targetItem.levelId === item.levelId && targetItem.id !== item.id) {
    //       return (targetItem.longitude === item.longitude) && (targetItem.latitude === item.latitude)
    //     }
    //   })
    //   if (isHasPoint > -1) {
    //     data.splice(index, 1)
    //   }
    // })
    // //console.log('事件点数据', data)
    // data.push({ //测试数据测试点位置是否准确
    //   name:'海珠广场',
    //   latitude:'23.115241',
    //   longitude:'113.265813',
    //   levelId:5
    // })
    data.forEach((e, i) => {
      if (e.longitude && e.latitude) {
        let icon = ''
        if (e.levelId == 1) {
          icon = new AMap.Icon({
            imageSize: new AMap.Size(36, 36),
            imageOffset:new AMap.Pixel(0,0),
            image: require('@/assets/images/roadOverview/map-event-icon1.png'),
          })
        } else if (e.levelId == 2) {
          icon = new AMap.Icon({
            imageSize: new AMap.Size(36, 36),
            imageOffset:new AMap.Pixel(0,0),
            image: require('@/assets/images/roadOverview/map-event-icon2.png'),
          })
        } else if (e.levelId == 3) {
          icon = new AMap.Icon({
            imageSize: new AMap.Size(36, 36),
            imageOffset:new AMap.Pixel(0,0),
            image: require('@/assets/images/roadOverview/map-event-icon3.png'),
          })
        } else if(e.levelId == 4){
          icon = new AMap.Icon({
            imageOffset:new AMap.Pixel(0,0),
            imageSize: new AMap.Size(36, 36),
            image: require('@/assets/images/roadOverview/map-event-icon4.png'),
          })
        } else {
          icon = new AMap.Icon({
            imageSize: new AMap.Size(36, 36),
            imageOffset:new AMap.Pixel(0,0),
            image:require('@/assets/images/roadOverview/map-event-icon5.png')
          })
        }
        let accidentMarker = new AMap.Marker({
          icon:icon,
          size:new AMap.Size(36,36), 
          offset: new AMap.Pixel(0,0),
          anchor:'bottom-center',
          position: [e.longitude, e.latitude],
          extData: e
        })

        // 信息窗（会有部分点无法展示展示窗的bug）
        // let infoWindow = new AMap.InfoWindow({
        //   offset: new AMap.Pixel(0, -36),
        // })
        let infoWindowObj = e
        if (infoWindowObj.trafficState == '1') {
          infoWindowObj.trafficState = '畅通'
        } else if (infoWindowObj.trafficState == '2') {
          infoWindowObj.trafficState = '缓行'
        } else if (infoWindowObj.trafficState == '3') {
          infoWindowObj.trafficState = '拥堵'
        } else if (infoWindowObj.trafficState == '4') {
          infoWindowObj.trafficState = '严重拥堵'
        }

        // 标记点的头部label,用于替代infoWindow
        accidentMarker.setLabel({
          direction:'top',
          // offset: new AMap.Pixel(110,-100),  //设置文本标注偏移量
          content: `<div id='test${i}'><div class="roadOverviewMarkerDialog-title">${infoWindowObj.name}</div>
            <div class="roadOverviewMarkerDialog-content mt_10">事件时间：${infoWindowObj.eventTime}</div>
            <div class="roadOverviewMarkerDialog-content mt_10">分    类：${
              infoWindowObj.categoryName == null ? '' : infoWindowObj.categoryName
            }</div>
            <div class="roadOverviewMarkerDialog-content mt_10">桩    号：${
              infoWindowObj.chaiageNum == null ? '' : infoWindowObj.chaiageNum
            }</div>
            <div class="roadOverviewMarkerDialog-content mt_10">交通状况：${infoWindowObj.trafficState}</div>
            </div>`, 
        });

        let top,left
        // 鼠标移入
        accidentMarker.on('mouseover', function (e) {
          // 对label样式修改并进行展示
          document.getElementById(`test${i}`).parentNode.style='display:block;position:absolute;top:-140px;left:-90px;'
          top = document.getElementById(`test${i}`).parentNode.parentNode.style.top
          left = document.getElementById(`test${i}`).parentNode.parentNode.style.left
          document.getElementById(`test${i}`).parentNode.parentNode.style=`z-index:101;top:${top};left:${left}`

          // 注册infoWindow内容并展示
          // if(clusterInfoWindow.value){
          //   clusterInfoWindow.value.close()
          // }
          // let infoWindowContent = `<div ><div class="roadOverviewMarkerDialog-title">${infoWindowObj.name}</div>
          //   <div class="roadOverviewMarkerDialog-content mt_10">事件时间：${infoWindowObj.eventTime}</div>
          //   <div class="roadOverviewMarkerDialog-content mt_10">分    类：${
          //     infoWindowObj.categoryName == null ? '' : infoWindowObj.categoryName
          //   }</div>
          //   <div class="roadOverviewMarkerDialog-content mt_10">桩    号：${
          //     infoWindowObj.chaiageNum == null ? '' : infoWindowObj.chaiageNum
          //   }</div>
          //   <div class="roadOverviewMarkerDialog-content mt_10">交通状况：${infoWindowObj.trafficState}</div>
          //   </div>`
          // console.log('进入',GDMap,infoWindowContent,e.target.getPosition());
          // infoWindow.setContent(infoWindowContent)
          // infoWindow.open(GDMap, e.target.getPosition())
        })
        // 鼠标移出
        accidentMarker.on('mouseout', function (e) {
          // 隐藏label
          document.getElementById(`test${i}`).parentNode.style='display:none'
          document.getElementById(`test${i}`).parentNode.parentNode.style=`z-index:100;top:${top};left:${left}`

          // 关闭infoWindow
          // infoWindow.close(GDMap, accidentMarker.getPosition())
        })

        accidentMarker.on('click', function (e) {
          if(clusterInfoWindow.value){
            clusterInfoWindow.value.close()
          }
          toEventDetailsFn(accidentMarker.getExtData())
        })

        if (e.levelId == 1) {
          accidentMarkerArr1.push(accidentMarker)
        } else if (e.levelId == 2) {
          accidentMarkerArr2.push(accidentMarker)
        } else if (e.levelId == 3) {
          accidentMarkerArr3.push(accidentMarker)
        } else if (e.levelId == 4) {
          accidentMarkerArr4.push(accidentMarker)
        } else if (e.levelId == 5) {
          accidentMarkerArr5.push(accidentMarker)
        }
      }
    })
    GDMap.add(accidentMarkerArr1)
    GDMap.add(accidentMarkerArr2)
    GDMap.add(accidentMarkerArr3)
    GDMap.add(accidentMarkerArr4)
    GDMap.add(accidentMarkerArr5)
    // 点击事件点聚合功能
    addCluster(accidentMarkerArr1, 'levelId', 1)
    addCluster(accidentMarkerArr2, 'levelId', 2)
    addCluster(accidentMarkerArr3, 'levelId', 3)
    addCluster(accidentMarkerArr4, 'levelId', 4)
    addCluster(accidentMarkerArr5, 'levelId', 5)
  }
}

// 地图资源设备打点
const drawRoadOverviewMarkerFn = (data, type) => {
  if (data.length > 0) {
    // 每次打点初始化数据,并且都需要清除点聚合对象
    mapDetailObj.mapIconArr10 = []
    if (personMarkerClusterer) {
      GDMap.remove(personMarkerClusterer)
      personMarkerClusterer = null
    }
    data.forEach((e, i) => {
      if (e.longitude && e.latitude) {
        let size = new AMap.Size(36,36) 
        let icon = new AMap.Icon({
          image:e.birdgeName != undefined
            ? mapIconList.value[0]
            : e.tollGateName != undefined
            ? mapIconList.value[1]
            : e.serviceAreaName != undefined
            ? mapIconList.value[2]
            : e.tunnelName != undefined
            ? mapIconList.value[3]
            : e.cameraName != undefined
            ? mapIconList.value[4]
            : e.portalName != undefined
            ? mapIconList.value[5]
            : e.vmsName != undefined
            ? mapIconList.value[6]
            : e.chainageName != undefined
            ? mapIconList.value[7]
            : e.realName != undefined
            ? mapIconList.value[9]
            : '', // Icon的图像
          imageSize: size, // 根据所设置的大小拉伸或压缩图片
          imageOffset:new AMap.Pixel(0,0),
        })
        let name = e.birdgeName != undefined
            ? e.birdgeName
            : e.tollGateName != undefined
            ? e.tollGateName
            : e.serviceAreaName != undefined
            ? e.serviceAreaName
            : e.tunnelName != undefined
            ? e.tunnelName
            : e.cameraName != undefined
            ? e.cameraName
            : e.portalName != undefined
            ? e.portalName
            : e.vmsName != undefined
            ? e.vmsName
            : e.chainageName != undefined
            ? e.chainageName
            : e.realName != undefined
            ? e.realName
            : ''
        if (e.realName != undefined) {
          let content = `<div class="markerBox">
          <img src="${mapIconList.value[9]}" class="markerImage"/>
          <div class="markerContent">
            <p>${e.realName}</p>
          </div>
        </div>`
          // let content = `<div class="personnel-map-box pr"><span class="personnel-map-box-item pa">${e.realName}</span></div>`
          mapDetailObj.roadOverviewMarker = new AMap.Marker({
            content: content,
            position: [e.longitude, e.latitude],
            size:new AMap.Size(36,36), 
            offset: new AMap.Pixel(40,0),
            anchor:'bottom-center',
            zIndex: 10,
            extData: e,
          })
        } else {
          mapDetailObj.roadOverviewMarker = new AMap.Marker({
            icon: icon,
            position: [e.longitude, e.latitude],
            size:new AMap.Size(36,36), 
            offset: new AMap.Pixel(0,0),
            anchor:'bottom-center',
            zIndex: 10,
            extData: e,
          })
        }

        let infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -36) })
        let infoWindowObj = e
        mapDetailObj.roadOverviewMarker.on('mouseover', function (e) {
          let infoWindowContent = ''
          if (infoWindowObj.realName != undefined) {
            infoWindowContent = `<div>
                <div class="roadOverviewMarkerDialog-content mt_10">部门：${infoWindowObj.orgName}</div>
                <div class="roadOverviewMarkerDialog-content mt_10">姓名：${name}</div>
                <div class="roadOverviewMarkerDialog-content mt_10">状态：${infoWindowObj.workStatus_dictText}</div>
                <div class="roadOverviewMarkerDialog-content mt_10">电话：${infoWindowObj.phone}</div>
                </div>`
          } else {
            infoWindowContent = `<div ><div class="roadOverviewMarkerDialog-title">${infoWindowObj.orgName}</div>
            <div class="roadOverviewMarkerDialog-content mt_10">名称：${name}</div>
            </div>`
          }
          infoWindow.setContent(infoWindowContent)
          infoWindow.open(GDMap, e.target.getPosition())
        })
        mapDetailObj.roadOverviewMarker.on('mouseout', function (e) {
          infoWindow.close(GDMap, mapDetailObj.roadOverviewMarker.getPosition())
        })

        mapDetailObj.roadOverviewMarker.on('click', (e) => {
          const extData = e.target.getExtData()
          ////console.log('extData:', extData)
          if (extData.chainageName != undefined) {
            yiGouObj.isMileageDetailShow = true
            yiGouObj.mileageId = extData.chainageCode
            ////console.log('chainageCode:', yiGouObj.mileageId)
          } else if (extData.vmsName != undefined) {
            yiGouObj.isInfoDetailShow = true
            yiGouObj.infoId = extData.vmsCode
          } else if (extData.portalName != undefined) {
            yiGouObj.isGantryDetailsShow = true
            yiGouObj.gantryId = extData.portalCode
          } else if (extData.cameraName != undefined) {
            yiGouObj.isVideoWindowShow = true
            yiGouObj.cameraNum = extData.cameraCode
          } else {
            // roadOverviewMarkerDialogFn(extData)
          }
        })
        GDMap.add(mapDetailObj.roadOverviewMarker)
        if (e.birdgeName != undefined) {
          mapDetailObj.mapIconArr1.push(mapDetailObj.roadOverviewMarker)
        } else if (e.tollGateName != undefined) {
          mapDetailObj.mapIconArr2.push(mapDetailObj.roadOverviewMarker)
        } else if (e.serviceAreaName != undefined) {
          mapDetailObj.mapIconArr3.push(mapDetailObj.roadOverviewMarker)
        } else if (e.tunnelName != undefined) {
          mapDetailObj.mapIconArr4.push(mapDetailObj.roadOverviewMarker)
        } else if (e.cameraName != undefined) {
          mapDetailObj.mapIconArr5.push(mapDetailObj.roadOverviewMarker)
        } else if (e.portalName != undefined) {
          mapDetailObj.mapIconArr6.push(mapDetailObj.roadOverviewMarker)
        } else if (e.vmsName != undefined) {
          mapDetailObj.mapIconArr7.push(mapDetailObj.roadOverviewMarker)
        } else if (e.chainageName != undefined) {
          mapDetailObj.mapIconArr8.push(mapDetailObj.roadOverviewMarker)
        } else if (e.realName != undefined) {
          mapDetailObj.mapIconArr10.push(mapDetailObj.roadOverviewMarker)
        }
        // else if (e.type==9) {
        //   mapDetailObj.mapIconArr9.push(mapDetailObj.roadOverviewMarker)
        // }
      }
    })
    if (type == 'gateInfo') {
      let middleIndex = Math.ceil(data.length / 2)
      GDMap.setCenter([data[middleIndex].longitude, data[middleIndex].latitude])
      // GDMap.setZoom(10.36)
      GDMap.setZoom(11.97)
    }
    // 点击人员点聚合功能
    if (type === 10) {
      addCluster(mapDetailObj.mapIconArr10, 'person')
    }
  }
}

// 值班人员和事件点聚合
function addCluster(markerArr, type, levelId){ 
  console.log('markerArr',markerArr)
  let typeClusterStyle = ''
  let typeEventClusterStyle = ''
  if (type === 'person') {
    typeClusterStyle = 'renderClusterBox'
    typeEventClusterStyle = 'renderClusterCount'
  } else {
    if (levelId === 1) {
      typeClusterStyle = 'renderEventClusterBox1'
      typeEventClusterStyle = 'renderEventClusterCount1'
    }
    if (levelId === 2) {
      typeClusterStyle = 'renderEventClusterBox2'
      typeEventClusterStyle = 'renderEventClusterCount2'
    }
    if (levelId === 3) {
      typeClusterStyle = 'renderEventClusterBox3'
      typeEventClusterStyle = 'renderEventClusterCount3'
    }
    if (levelId === 4) {
      typeClusterStyle = 'renderEventClusterBox4'
      typeEventClusterStyle = 'renderEventClusterCount4'
    }
    if (levelId === 5) {
      typeClusterStyle = 'renderEventClusterBox5'
      typeEventClusterStyle = 'renderEventClusterCount5'
    }
  }
  let _renderClusterMarker = function(context){
    let content=`<div class="renderAnyClusterBox ${typeClusterStyle}">
      <div class="renderAnyClusterCount ${typeEventClusterStyle}">${context.count}</div></div>`
    context.marker.setOffset(new AMap.Pixel(-21, -21));
    context.marker.setContent(content)
  }
  let _renderMarker = function(context) {
    let content = `<div class="markerBox">
      <img src="${mapIconList.value[9]}" class="markerImage"/>
      <div class="markerContent">
        <p>${context.data[0].realName}</p>
      </div>
    </div>`
    var offset = new AMap.Pixel(0,0);
    context.marker.setContent(content)
    context.marker.setOffset(offset)
    context.marker.setAnchor('bottom-center')
  }
  if(!personMarkerClusterer && type === 'person'){
    personMarkerClusterer = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 60, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
        // clusterByZoomChange:true,
      }
    )
    personMarkerClusterer.on('click',(ele)=>{
      // 2.0版本的使用 
      // clusterArr.value = ele.clusterData
      // clusterInfoWindow.value = new AMap.InfoWindow({
      //   offset:ele.clusterData.length>1 ? new AMap.Pixel(0,-36) : new AMap.Pixel(0, -36),
      //   anchor:'bottom-center',
      //   content:clusterWindowBoxRef.value,
      //   isCustom:true
      // })
      // clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])

      // 1.4.15版本的使用
      if (GDMap.getZoom() === 18) {
        clusterArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
  if(!eventMarkerClusterer1 && type === 'levelId' && levelId === 1){
    eventMarkerClusterer1 = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 0, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
      }
    )
    eventMarkerClusterer1.on('click',(ele)=>{
      if (GDMap.getZoom() === 18) {
        clusterEventArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterEventArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterEventWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
  if(!eventMarkerClusterer2 && type === 'levelId' && levelId === 2){
    eventMarkerClusterer2 = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 0, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
      }
    )
    eventMarkerClusterer2.on('click',(ele)=>{
      if (GDMap.getZoom() === 18) {
        clusterEventArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterEventArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterEventWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
  if(!eventMarkerClusterer3 && type === 'levelId' && levelId === 3){
    eventMarkerClusterer3 = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 0, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
      }
    )
    eventMarkerClusterer3.on('click',(ele)=>{
      if (GDMap.getZoom() === 18) {
        clusterEventArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterEventArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterEventWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
  if(!eventMarkerClusterer4 && type === 'levelId' && levelId === 4){
    eventMarkerClusterer4 = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 0, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
      }
    )
    eventMarkerClusterer4.on('click',(ele)=>{
      if (GDMap.getZoom() === 18) {
        clusterEventArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterEventArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterEventWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
  if(!eventMarkerClusterer5 && type === 'levelId' && levelId === 5){
    eventMarkerClusterer5 = new AMap.MarkerClusterer(
      GDMap,
      markerArr,
      {
        renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
        renderMarker: _renderMarker, // 自定义非聚合点样式
        gridSize: 0, //聚合计算时网格的像素大小
        maxZoom: 18, //最大的聚合级别
        zoomOnClick:true,
      }
    )
    eventMarkerClusterer5.on('click',(ele)=>{
      if (GDMap.getZoom() === 18) {
        clusterEventArr.value.length = 0
        ele.markers.forEach((item)=>{
          clusterEventArr.value.push(item.getExtData())
        })
        clusterInfoWindow.value = new AMap.InfoWindow({
          offset:new AMap.Pixel(0,-36),
          anchor:'bottom-center',
          content:clusterEventWindowBoxRef.value,
          isCustom:true
        })
        clusterInfoWindow.value.open(GDMap, [ele.lnglat.lng,ele.lnglat.lat])
      }
    })
  }
}

#container {
  min-height: 968px;
}
/deep/ .markerBox{
  display: flex;
  .markerImage{
    width: 40px;
    height: 40px;
    position: absolute;
    left: -2px;
  }
  .markerContent{
    color: #fff;
    background: #8A6BFA;
    height: 36px;
    line-height: 36px;
    max-width: 265px;
    min-width: 120px;
    border-radius:40px;
    padding-right:10px;
    p{
      margin-left: 45px;
      text-align:left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
}
/deep/ .renderAnyClusterBox {
  width: 60px;
  height: 60px;
  border-radius: 60px;
}
/deep/ .renderAnyClusterCount {
  width: 42px;
  height: 42px;
  border-radius: 42px;
  line-height: 42px;
  text-align: center;
  color: #fff;
  font-size: 18px;
  margin: auto;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
}
/deep/ .renderClusterBox{
  background: rgba(138, 107, 250, 0.3);
}
/deep/ .renderClusterCount{
  background: rgba(138,107,250,0.8);
  border: 2px solid #6130F0;
}
/deep/ .renderEventClusterBox1{
  background: rgba(252, 105, 59, 0.3);
}
/deep/ .renderEventClusterCount1{
  background: rgba(252, 105, 59, 0.8);
  border: 2px solid rgba(252, 105, 59);
}
/deep/ .renderEventClusterBox2{
  background: rgba(255, 148, 71, 0.3);
}
/deep/ .renderEventClusterCount2{
  background: rgba(255, 148, 71, 0.8);
  border: 2px solid rgba(255, 148, 71);
}
/deep/ .renderEventClusterBox3{
  background: rgba(255, 187, 47, 0.3);
}
/deep/ .renderEventClusterCount3{
  background: rgba(255, 187, 47, 0.8);
  border: 2px solid rgba(255, 187, 47);
}
/deep/ .renderEventClusterBox4{
  background: rgba(27, 127, 255, 0.3);
}
/deep/ .renderEventClusterCount4{
  background: rgba(27, 127, 255, 0.8);
  border: 2px solid rgba(27, 127, 255);
}
/deep/ .renderEventClusterBox5{
  background: rgba(71, 206, 90, 0.3);
}
/deep/ .renderEventClusterCount5{
  background: rgba(71, 206, 90, 0.8);
  border: 2px solid rgba(71, 206, 90);
}
/deep/ .clusterWindowBox{
  display: flex;
  flex-wrap: wrap;
  width: 443px;
  max-height: 295px;
  background: #FFFFFF;
  border-radius: 10px;
  overflow: auto;
  padding: 0 10px 0 20px;
  text-align: left;
  position: relative;
  .oneCluster.clusterWindowItem{
    width:100%;
    border-right: none !important;
  }
  .clusterWindowItem{
    width: 50%;
    font-size: 18px;
    color: #6B7299;
    padding-left: 20px;
    border-top: 1px solid #EEEEEE;
    padding-top:20px;
    padding-bottom:10px;
    padding-right: 20px;
    p{
      margin-bottom:10px;
      margin-top:0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  }
  .clusterEventWindowItem {
    cursor: pointer;
    font-size: 16px;
  }
  .clusterEventWindowItem-name {
    font-size: 18px;
    font-weight: 700;
  }
  .clusterWindowItem:nth-child(1),.clusterWindowItem:nth-child(2){
    border-top: none;
  }
  .clusterWindowItem:nth-of-type(2n+1){
    padding-left: 0;
    border-right:1px solid #EEEEEE;
  }
}
```



## 轮询接口

```js
// 5分钟刷新一次路况接口及右侧统计接口
let facilitiesAndEventInfoTimer = ref(null)
const circulateEvent = () => {
  facilitiesAndEventInfoTimer.value = setTimeout(() => {
    let parameter = {
      sysOrgCode: sysOrgCode,
    }
    mapObj.sectionIdArr = []
    getHighwaySectionApi(parameter).then((data) => {
        clearTimeout(facilitiesAndEventInfoTimer.value)
        //console.log('getHighwaySectionApiFn-data:', data)
        let result = data.result
        let sectionIdArr = []
        if (data.code == 200) {
          if (result && result.length > 0) {
            result.forEach((e) => {
              sectionIdArr.push(e.sectionId)
            })
            mapObj.sectionIdArr = sectionIdArr.join(',')
            mapObj.eventList = []
            eventPageNo.value = 1
            queryEventInfoApiFn()
            queryConfirmedEventApiFn()
          }
          circulateEvent()
        } else {
          //console.log(data.message)
        }
    })
  }, 30000)
}
```



## 分段渲染多数据

- 通过定时器分段渲染数据，最后循环清除所有定时器

> 注意：做不到通过判断每次渲染条数再去渲染下一段数据，最后等全部数据拿到再渲染到页面上

```js
//根据路段画线路
const _drawPolylineFn = (tmcs,type) => {
    let tmcsLength = 0
        tmcsLength = tmcs.length
    let colorArr = ['#04D099','#FFCC00','#FF0033','#660033'],pathArr = []
    if(tmcs.length>0){
        let polylineColor = ''
        let polyline = ''
        for(let i=0;i<tmcsLength;i++){
            polylineColor = 
                tmcs[i].tmc_status == '畅通'
                ? colorArr[0]
                : tmcs[i].tmc_status == '缓行'
                ? colorArr[1]
                : tmcs[i].tmc_status == '拥堵'
                ? colorArr[2]
                : tmcs[i].tmc_status == '严重拥堵'
                ? colorArr[3]
                : colorArr[0]
            if(tmcs[i].tmc_polyline_arr.length>0){
                polyline = new AMap.Polyline({
                path: tmcs[i].tmc_polyline_arr,
                borderWeight: 2, // 描边的宽度，默认为1
                strokeWeight:5, // 线条宽度
                strokeColor: polylineColor, // 线条颜色
                lineJoin: 'round', // 折线拐点连接处样式
                lineCap:'round',//圆头
                isOutline:true, // 线条是否带描边
                outlineColor:polylineColor, //线条描边颜色
                zIndex: 10
                });
                mapDetailObj.polylineArr.push(polyline);
            }
        }
        GDMap.add(mapDetailObj.polylineArr)
    }
    type++
    let loopFnTimer = setTimeout(function(){
        _loopFn(eventDetailsObj.mapLineData[`${type}`], type)
        if (type === eventDetailsObj.mapLineData.length) {
            loopFnTimerArr.forEach((item) => {
                clearTimeout(item)
            })
            loopFnTimerArr = []
        }
    }, 200)
    loopFnTimerArr.push(loopFnTimer)
}
function _loopFn(lineRoadData,type){
    if(type<eventDetailsObj.mapLineData.length){
        _drawPolylineFn(lineRoadData,type)
    }
}
```



## 动态路由

```javascript
let addRoutes = (menuDatas) => {
    menuDatas.forEach(item => {
        let name = item.name.split('-')[item.name.split('-').length - 1] || ''
        if (item.children && item.children.length != 0) {
            item.children.forEach(v => {
                let names = v.name.split('-')[v.name.split('-').length - 1] || ''
                // console.log("打印看看：", names, v.component)
                router.addRoute('index', {
                    path: v.path,
                    name: names,
                    component: () => import(`@/views/${v.component}`),
                    meta: {
                        title: v.meta.title,
                        keepAlive: v.meta.keepAlive
                    }
                })
            });
        } else if (item.meta.title !== '首页') {
            router.addRoute('index', {
                path: item.path,
                name: name,
                component: () => import(`@/views/${item.component}`),
            })
        }
    });
}
```



## 上传单个图片

- 不支持上传视频格式、上传音频格式
- 文件超过2M, 请重新上传
- 图片尺寸超过18px*18px，请重新上传！

```js
<!-- 事件图标 -->
<a-col :span="12" :offset="1" class="avatarItem">
  <a-form-item
    label="事件图标"
    name="icon"
  >
    <a-upload
        name="file"
        :file-list="iconList"
        :beforeUpload="iconBeforeUpload"
        @change="iconHandleChange"
        :max-count="1"
        :show-upload-list="false"
    >
        <img v-if="formState.icon" :src="formState.icon" alt="avatar" class="avatar" />
        <a-button>上传文件</a-button>
    </a-upload>
    <div class="warning-container">
        <img class="warning" src="@/assets/images/roadOverview/warning_icon.png" alt>
        <div>支持上传JPG,JPEG,PNG,BMP格式文件大小不大于2MB</div>
    </div>
  </a-form-item>
</a-col>
  
// 图标上传
const iconList = ref([]);

const iconHandleChange = (info) => {
  const formData = new FormData()
  if (info.file.status != 'uploading') {
    let file = iconList.value[0]
    formData.append("file", file);
    if (file.type.includes("image")){
      formData.append("biz", "img");
    } else if (file.type.includes("video")) {
      message.warning('不支持上传视频格式')
      return
      // formData.append("biz", "video");
    }else if (file.type.includes("audio")) {
      message.warning('不支持上传音频格式')
      return
      // formData.append("biz", "voice");
    }
    uploadApi(formData).then((data) => {
      if (data.code == 200) {
        message.success("上传成功");
        formState.icon = data.message
      } else {
        message.warn("上传失败");
      }
    })
  }
};

// 图标上传前
const iconBeforeUpload = async(file) => {
  const isJpgOrPng = file.type.includes("bmp")|| file.type.includes("jpg") || file.type.includes("png") || file.type.includes("jpeg") 
  if (!isJpgOrPng) {
    message.error('该文件类型暂不支持上传，请重新上传！');
    return
  }
  const isLt2M = file.size / 1024 / 1024 < 2;
  if (!isLt2M) {
    message.error('文件超过2M, 请重新上传');
    return
  }
  const image = new Image();
  image.src = window.URL.createObjectURL(file);
  await new Promise((resolve, reject) => {
    image.onload = resolve;
    image.onerror = reject;
  });
  const isSize = image.width <= 18 && image.height <= 18;
  if (!isSize) {
    message.error("图片尺寸超过18px*18px，请重新上传！");
    return;
  }

  iconList.value = [file]
  return isJpgOrPng && isLt2M && isSize;
};


.avatarItem{
  .avatar{
    width: 1.875rem;
    margin: 0 10px;
    background-color: #cbcbcb;
  }

  /deep/ .ant-form-item-control-input-content{
    display: flex;
    align-items: center;
  }

  .warning-container{
    color: #34A2FB;
    display: flex;
    width: 13.75rem;
    margin-left: .625rem;
    align-items: center;
    .warning{
      width: 1.25rem;
      height: 1.25rem;
    }
  }
}
```



## 聊天功能

```js
/*******获取群聊websocket推送消息*/
function initWebSocket() {
  // WebSocket与普通的请求所用协议有所不同，ws等同于http，wss等同于https
  //type固定值 pc userId当前登录人id  eventId 当前事件id
  var userId = store.state.userInfo.id;
  var url = (process.env.VUE_APP_API_HOST4).replace("https://","wss://").replace("http://","ws://")+"websocket/pc/"+userId+'/' + globalData.eventDetailsObj.id
  // +'/'+new Date().getTime();
  console.log("url",url);
  console.log("globalData.websockSign",globalData.websockSign);
  if(globalData.websockSign !== null && globalData.websockSign.readyState == 1){
    //避免重复链接
    console.log("websocket 连接已存在...");
  }else{
    globalData.websockSign = new WebSocket(url);
    globalData.websockSign.onopen = (e)=>websocketOnopen(e);
    globalData.websockSign.onerror = (e)=>websocketOnerror(e);
    globalData.websockSign.onmessage =(e)=>websocketOnmessage(e);
    globalData.websockSign.onclose = (e)=>websocketOnclose(e);
  }
}
const websocketOnopen = (e) => {
  console.log("WebSocket连接成功",e);
  message.success('长连接已连上')
}
const websocketOnerror = (e) => {
  console.log('WebSocket连接发生错误: ' + e.code + ' ' + e.reason + ' ' + e.wasClean)
  if(num==0)message.error('长连接已断开')
  if(e.code !== 1000){
    console.log("websocket 非正常断开重连...");
    reconnect();
  }
}
let chatHistoryTimer2 = ref(null)
const websocketOnmessage = (e) => {
  videoTotal.value = scenVideoTotal.value
  let msgCon = eval("(" + e.data + ")")
  let msgList = msgCon.msgList; //解析对象
  console.log('websocketOnmessage接收内容',eval("(" + e.data + ")"))
  globalData.groupChatArr = msgList
  globalData.groupChatArr.map(item=>{
    item.msg.map(ele=>{
      ele.showDurationSeconds = ele.videoTime * 1
      ele.isPlay = false
      if (!!ele.videoUrl) {
        videoTotal.value = videoTotal.value + 1
        ele.videoTotal = videoTotal.value
      }
    })
  })
  //刷新流程跟踪节点树(判断是否为app传过来的消息 是则刷新)
  if(msgCon.channelId && msgCon.eventId && msgCon.type === "app"){
    globalData.taskNodeList.forEach((item,index)=>{
      if(item.status != 0 && item.status != '-1'){
        getTaskNodeApiFn(item.channelId)
      }
    })
  }
  //如果app发送消息的类型是eventInfo，重新刷新事件详情内容
  // pc发送消息,重新刷新事件详情内容
  if(msgCon.type === "eventInfo"){
    findByEventIdApi({eventId:router.currentRoute._value.query.eventId || props.eventDetailData}).then(res=>{
      if (res.code === 200) {
        let tmpResult = res.result && res.result.records[0]
        tmpResult.startTime = tmpResult.startTime ? dayjs(tmpResult.startTime,'YYYY-MM-DD HH:mm:ss') : null
        tmpResult.endTime = tmpResult.endTime?dayjs(tmpResult.endTime,'YYYY-MM-DD HH:mm:ss') : null
        tmpResult.levelId = tmpResult.levelId ? tmpResult.levelId +'':null
        tmpResult.relVehicleInfoJson = tmpResult.relVehicleInfoJson ?JSON.parse(tmpResult.relVehicleInfoJson):[]
        globalData.eventDetailsObj = tmpResult
      }
    })
  }
  //设置滚动条到最底部
  let chatHistory = document.getElementById("chatBox");
  if(chatHistory){
    // if (chatHistory.scrollHeight > chatHistory.clientHeight) {
      chatHistoryTimer2.value = setTimeout(function () {
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }, 1000 * 0.1);
    // }
  }
  if(eventDynamicsRef.value && msgCon.type === "app"){
    eventDynamicsRef.value.queryTimelineByIdFn(globalData.eventDetailsObj.id) //获取时间轴信息
  }
  eventAddApiFn()
}
const websocketOnclose = (e) => {
  console.log('websocket 断开: ' + e.code + ' ' + e.reason + ' ' + e.wasClean)
  if(e.code !== 1000){
    console.log("websocket 非正常断开重连...");
    reconnect();
  }
}
```



## 按钮权限控制

```js
//permission.js
//请求菜单、用户信息
getUserPermisson({ token: res.result.token }).then(res2 => {
    if (res2.code === 200 && res2.success) {
        store.dispatch('userInfo', res2.result.userInfo);
        store.dispatch('auth', res2.result.auth);
        //动态处理路由
        addRoutes(res2.result.menu);
        //储存菜单数据
        setStorage('menuDatas', res2.result.menu)
    }
    //默认跳转首页
    let goUrl = '/scheduling-page/index'
  //如果是大屏
  if(to.query.redirectParam && to.query.redirectParam === "lsdPage" ){
    goUrl = '/scheduling-page/lsd/visualization'
  }
  next({ path: goUrl })
}).catch(() => {
    //接口请求失败，提示然后跳转到一体化
    message.error(res.message);
    setTimeout(() => {
        removeStorage();
        window.location.replace(process.env.VUE_APP_API_HOST2);
        window.name="'一体化平台'"
    }, 2000);
});

// buttonPermissions.js
// 按钮权限
import store from '@/store/store'

const buttonPermissions = (app) => {
  app.directive("buttonCode", {
    // 渲染完毕
    mounted(el, binding) {
      // 获取权限
      let auth = store.state.auth
      // 对比已有权限和按钮的权限字符
      let res = auth.some((item) => {
        return binding.value == item.action
      })
      if(!res) el.remove()
    }
  })
}
export default buttonPermissions

// main.js
import buttonPermissions from "./utils/directive/buttonPermissions"; //按钮权限
app.use(buttonPermissions) //按钮权限 指令型 v-buttonCode
```



## 卫星地图

```js
// 切换卫星地图
 const isSatelliteLayer = ref(false)
 let satellite = new AMap.TileLayer.Satellite()
 let roadNet = new AMap.TileLayer.RoadNet()
 const toggleMapLayer = () => {
     // 切换地图图层
     if (isSatelliteLayer.value) {
         GDMap.remove([satellite, roadNet])
         GDMap.setMapStyle(`amap://styles/02fd07714a3aac53f6cdf9b02998f192`)
     }
     // 切换卫星地图
     else {
         GDMap.add([satellite, roadNet])
     }
     isSatelliteLayer.value = !isSatelliteLayer.value
 }
```



## 腾讯地图

- `uniapp `不支持高德地图，所以选择了腾讯地图
- 需要生产key关联`appid`
- 设置request合法域名，添加`https://apis.map.qq.com`
-  路线规划功能仅适用于 [jssdkv1.2](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview)，下载完后放在项目根目录下面的`static`文件夹下面

```javascript
<!-- 救援定位组件 -->
<template>
	<view class="secure-position-box" >
		<map class="secure-position-box__map" id="mapDom" :latitude="dataSource.markers[0].latitude" :longitude="dataSource.markers[0].longitude"
			:markers="dataSource.markers" :polyline="dataSource.polyline" show-location="true"></map>
		<view v-if="rescueType === 1" class=secure-position-box__wrap>
			<!-- 定位信息 -->
			<view class="secure-position-box__content">
				<view class="secure-position-box__info">
					<view class="secure-position-box__info--title">定位信息</view>
					<view class="secure-position-box__info--position" @click="resetPosition">重新定位</view>
				</view>
				<view class="secure-position-box__detail">
					<image class="secure-position-box__detail--icon" src="/static/images/resuce/marker-icon.png"
						mode="aspectFill"></image>
					<view class="secure-position-box__detail--location">{{ dataSource.roadData.roadName }}</view>
				</view>
			</view>
			<!-- 一键救援 -->
			<view class="secure-position-box__rescue">
				<view class="secure-position-box__rescue--operate">
					<view class="secure-position-box__rescue-team">
						<view class="secure-position-box__rescue-team--name">救援队</view>
						<view class="secure-position-box__rescue-team--phone">02080808080</view>
					</view>
					<view class="secure-position-box__rescue--icon">
						<image class="secure-position-box__rescue--icon-video"  @click="toPhone()" src="@/static/images/resuce/rescue-phone-green.png"
							mode="aspectFill"></image>
						<image class="secure-position-box__rescue--icon-phone" src="/static/images/resuce/rescue-video.png"
							mode="aspectFill"></image>
					</view>
				</view>
				<button class="secure-position-box__rescue--btn" @click="toRescueInformation">一键救援</button>
			</view>
		</view>
		<view class="topTip" v-if="rescueType === 2">
			<view class="topTipFlex">
				<view class="topTipLeft">
					<image class="icon" src="@/static/images/resuce/rescue-loding.png"></image>
					<text class="time">{{ minute }}:{{ second }}</text>
				</view>
				<view class="topTipRight">
					<view class="topBox">等待救援队响应...</view>
					<view class="botBox">
						<image class="icon" src="@/static/images/resuce/rescue-video-grey.png"></image>
						<view>视频电话</view>
						<image class="icon" @click="toPhone()" src="@/static/images/resuce/rescue-phone-green.png"></image>
						<view>语音电话</view>
					</view>
				</view>
			</view>
			<view class="topTipBtn" @click="cancellation">取消</view>
		</view>
		<view class="botTip" v-if="rescueType === 3">
			<view class="botTipTitle">
				<view class="titleLeft">救援队正努力赶来</view>
				<view class="titleRight">预计<text> {{ dataSource.reachTime }} </text>到达</view>
			</view>
			<view class="botTipList">
				<text class="label">救援人员</text>
				<text class="name">{{ dataSource.rescueTeamData.rescueName }}</text>
				<text class="phone">{{ dataSource.rescueTeamData.rescueMobile }}</text>
				<image class="icon" @click="toPhone(dataSource.rescueTeamData.rescueMobile)" src="@/static/images/resuce/rescue-phone-green.png"></image>
			</view>
			<view class="botTipList">
				<text class="label">救援类型</text>
				<text class="name" v-if="dataSource.rescueTeamData.rescueType === 1"> 拖车 </text>
				<text class="name" v-if="dataSource.rescueTeamData.rescueType === 2"> 救护车 </text>
				<text class="name" v-if="dataSource.rescueTeamData.rescueType === 3"> 交通事故 </text>
				<text class="name" v-if="dataSource.rescueTeamData.rescueType === 4"> 补胎 </text>
				<text class="name" v-if="dataSource.rescueTeamData.rescueType === 5"> 车辆事故 </text>
			</view>
			<view class="botTipList">
				<text class="label">所在高速</text>
				<text class="name">{{ dataSource.rescueTeamData.highwayName }}</text>
			</view>
			<view class="botTipList">
				<text class="label">救援车牌</text>
				<text class="name">{{ dataSource.rescueTeamData.rescuePlateNumber }}</text>
			</view>
		</view>
	</view>
</template>

<script setup>
import { ref, watch, reactive, onMounted,getCurrentInstance } from "vue"
import { onLoad, onShow, onReady } from '@dcloudio/uni-app'
let { proxy } = getCurrentInstance();
import { request } from '/request/index.js'
// 引入SDK核心类，js文件根据自己业务，位置可自行放置
let QQMapWx = require('../../static/utils/qqmap-wx-jssdk.min.js');
// 实例化API核心类
const qqmapsdk = new QQMapWx({
	key: "SWWBZ-YPGCC-3JU2Y-AQZXX-QD2CF-SLB2Z",
});

// 数据源
const dataSource = reactive({
	// 通过经纬度获取路段信息
	roadData: {},
	// 救援车预计到达时间
	reachTime:'',
	// 救援队信息
	rescueTeamData:{},
	// 标记点(起点，终点)
	markers: [
		{
			id: 0,
			latitude: "",
			longitude: "",
			width: 22, //宽
			height: 30, //高
			iconPath: "../../static/images/resuce/marker-icon-red.png",
		},
	],
	// 线路
	polyline: [{
		points: [],
		color: "#5977ff",
		width: 5,
		// dottedLine: true,//是否虚线
		arrowLine: true,//是否带箭头
	}],
	// 地图实例
	mapDom:{}
})

// 根据经纬度计算两点的方向（动态控制救援车图标方向）
const bearing = (start, end) =>{
	let rad = Math.PI / 180,
	lat1 = start.latitude * rad,
	lat2 = end.latitude * rad,
	lon1 = start.longitude * rad,
	lon2 = end.longitude * rad;
    const a = Math.sin(lon2 - lon1) * Math.cos(lat2);
    const b = Math.cos(lat1) * Math.sin(lat2) -
	Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
	const degrees = Math.atan2(a, b) % (2 * Math.PI);
    return degrees * 180 / Math.PI;
}

// 通过经纬度获取详细地址接口
const getAdress = async (lon,lat) => {
	try {
		let {data: res} = await request({
			url: `/highway-applet/api/rescue/getHighwayByLngLat?longitude=${lon}&latitude=${lat}`,
			method: "get",
		})
		dataSource.roadData = res.result || {}
	} catch (error) {
		console.log('error', error)
	}
}

// 获取当前定位信息
const getLocate = () => {
	uni.getLocation({
		type: "gcj02",
		success: res => {
			dataSource.markers[0].longitude = res.longitude;//经度
			dataSource.markers[0].latitude = res.latitude;//维度
			// 通过经纬度获取详细地址
			getAdress(res.longitude,res.latitude)
			// 坐标转详细地址(sdk自带)
			// qqmapsdk.reverseGeocoder({
			// 	location: {
			// 		longitude: res.longitude,
			// 		latitude: res.latitude
			// 	},
			// 	//成功后的回调
			// 	success: (r) => {
			// 		console.log('地址信息', r.result);
			// 		dataSource.position = r.result.formatted_addresses.recommend
			// 	},
			// 	fail: function (res) {
			// 		console.log(res);
			// 	}
			// })
		},
		fail: res => {
			console.log(res);
		}
	});
};
// 获取线路规划线路数据
// 查询地图路线
const getQueryMapRoutine = (isClear = false) =>{
	qqmapsdk.direction({
    mode: 'driving', // 'driving'(驾车路线规划)
    // from参数不填默认当前地址
    from: {
		latitude: isClear ? dataSource.markers[0].latitude : dataSource.markers[1].latitude,
		longitude: isClear ? dataSource.markers[0].longitude : dataSource.markers[1].longitude,
	},
	to:{
		latitude: dataSource.markers[0].latitude,
		longitude: dataSource.markers[0].longitude,
	},
    success: (res) => {
		if(isClear){
			dataSource.polyline[0].points = []
			return false
		}
		console.log('路线规划结果', res);
		let coors = res.result.routes[0].polyline
		let pl = []
		//坐标解压（返回的点串坐标，通过前向差分进行压缩）
		let kr = 1000000;
		for (let i = 2; i < coors.length; i++) {
			coors[i] = Number(coors[i - 2]) + Number(coors[i]) / kr;
		}
		//将解压后的坐标放入点串数组pl中
		for (let i = 0; i < coors.length; i += 2) {
			pl.push({ latitude: coors[i], longitude: coors[i + 1] })
		}
		dataSource.polyline[0].points = pl
		// 总距离
		let distance = res.result.routes[0].distance >1000 ? (res.result.routes[0].distance/1000).toFixed(2) + "Km" : res.result.routes[0].distance + "m"
		dataSource.markers[1].callout.content = `距您${distance}`
		// 总时长(res.result.routes[0].duration))
		let time = new Date()
		let addTime = new Date(time.setMinutes(time.getMinutes() + res.result.routes[0].duration))
		let hours = addTime.getHours() < 10 ? "0" + addTime.getHours() : addTime.getHours()
		let minutes = addTime.getMinutes() < 10 ? "0" + addTime.getMinutes() : addTime.getMinutes()
		dataSource.reachTime = hours + ':' + minutes
		// 根据经纬度计算两点的方向角度
		dataSource.markers[1].rotate = bearing({
		latitude: dataSource.markers[1].latitude,
		longitude: dataSource.markers[1].longitude,
	},pl[1]) - 180
    }
  })
}
// 视野回到当前定位
const resetView = () =>{
	uni.createMapContext("mapDom", proxy).moveToLocation()
}

// 重新定位
const resetPosition = () => {
	getLocate()
	resetView()
}


const rescueType = ref(1)//救援状态
const minute = ref('00')//分
const second = ref('00')//秒
let timer = null //计时器轮询
let orderTimer = null //订单轮询
watch(rescueType, (val) => {
	// 等待救援队时间（开启计时器）
	if (val === 2) {
		timer = setInterval(() => {
			second.value++
			minute.value = parseInt(minute.value)
			if (second.value < 10) {
				second.value = '0' + second.value
			}
			if (second.value > 59) {
				second.value = '00'
				minute.value++
			}
			if (minute.value < 10) {
				minute.value = '0' + minute.value
			}
		}, 1000)
	}
	if(val !== 2){
		// 停止计时器
		clearInterval(timer)
		timer = null
		minute.value = '00'
		second.value = '00'
	}
	// 轮询查看救援状态
	if(val === 2 || val === 3){
		// 停止计时器
		clearInterval(orderTimer)
		orderTimer = null
		orderTimer = setInterval(()=>{
			getOrderStatus()
		},5000)
	}
})

// 取消救援
const cancellation = async() => {
	// 主动取消救援接口
	try {
		let res = await request({
			url: `/highway-applet/api/rescue/cancelRescue`,
			method: "put",
			data: {id:uni.getStorageSync('informationData').id}
		})
		if(res.data.code === 200){
			uni.showToast({
            title: res.data.message,
            icon: 'success',
            mask: true,
        });
			rescueType.value = 1
			//救援状态
			uni.setStorageSync('isTabbar',1)
			uni.removeStorageSync('informationData') // 删除缓存的救援信息、
		}
		} catch (error) {
			console.log('error', error)
	}

}

// 查看当前订单状态
const getOrderStatus = async() =>{
	try {
		let res = await request({
			url: `/highway-applet/api/rescue/getListByUserId?cusUserId=${uni.getStorageSync('userInfo').id}`,
			method: "get",
			isLoading:true
		})
		// getRecordByUserId
		if(res.data.result.length === 0) {
			clearInterval(orderTimer)
			orderTimer = null
			rescueType.value = 1
			uni.setStorageSync('isTabbar',1)
			// 订单结束删除线路并删除救援图标
			if(dataSource.markers.length == 2){
				dataSource.markers.splice(1,1)
				getQueryMapRoutine(true)
			}
			return false
		
		}
		let data = dataSource.rescueTeamData = res.data.result[0]
		// 救援待确认
		if(data.status == 0){
			rescueType.value = 2
			uni.setStorageSync('isTabbar',2)
			uni.setStorageSync('informationData',data)
		}
		// 已确认等待救援
		if(data.status == 1){
			rescueType.value = 3
			uni.setStorageSync('isTabbar',3)
			// 救援车图标位置
			dataSource.markers[1] = {
				id: 1,
				latitude: data.rescueLatitude,
				longitude:  data.rescueLongitude,
				callout: {
					content: '',
					color: "#ccc",
					fontSize: "16",
					borderRadius: "6",
					bgColor: "#ffffff",
					padding: "10",
					display: "ALWAYS",
					anchorY:15
				},
				width: 15,
				height: 30,
				iconPath: "../../static/images/resuce/marker-icon-end.png",
				rotate:0//旋转角度
			}
			// 画线路
			getQueryMapRoutine()
		}
		// 救援结束|主动取消
		if(data.status == 2 || data.status == 3){
			// 停止计时器
			clearInterval(orderTimer)
			orderTimer = null
			rescueType.value = 1
			uni.setStorageSync('isTabbar',1)

		}
		// 救援结束清掉路线
		if(data.status == 2 ){
			uni.switchTab ({
			url: '/pages/rescue/rescue'
		});
		}
	} catch (error) {
		console.log('error', error)
	}
}

// 点击一键救援
const toRescueInformation = () => {
	uni.navigateTo({
		url: '/pages/preparation/preparation?params=' + JSON.stringify(dataSource.roadData)
	});
}

// 唤起拨号页面
const toPhone = (data) =>{
	let phone = data || '02080808080';
	const res = uni.getSystemInfoSync();
	// ios系统默认有个模态框
	if (res.platform == 'ios') {
		uni.makePhoneCall({
			phoneNumber: phone,
			success() {
				console.log('拨打成功了');
			},
			fail() {
				console.log('拨打失败了');
			}
		})
	} else {
		//安卓手机手动设置一个showActionSheet
		uni.showActionSheet({
			itemList: [phone, '呼叫'],
			success: function(res) {
				console.log(res);
				if (res.tapIndex == 1) {
					uni.makePhoneCall({
						phoneNumber: phone,
					})
				}
			}
		})
	}
}

onShow(() => {
	// 从存储里获取当前状态
	rescueType.value = uni.getStorageSync('isTabbar') || rescueType.value;
})
onLoad(()=>{
	// 获取定位
	getLocate()
	// 获取订单状态
	getOrderStatus()
})






</script>

<style lang="scss" scoped>
.secure-position-box {
	box-sizing: border-box;
	/* height: calc(100vh - 395rpx); */
	height: 100vh;

	&__map {
		width: 100%;
		height: 100%;
	}

	&__wrap {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		height: 446rpx;
		background: #FFFFFF;
		border-radius: 38rpx 38rpx 0 0;
	}

	/* #ifdef H5 */
	&__wrap {
		position: fixed;
		bottom: 100rpx;
		left: 0;
		right: 0;
		height: 446rpx;
		background: #FFFFFF;
		border-radius: 38rpx 38rpx 0 0;
	}

	/* #endif */

	&__content {
		padding: 22rpx 42rpx 38rpx 38rpx;
		border-bottom: 2rpx solid #D2D2D2;
	}

	&__info {
		display: flex;
		justify-content: space-between;
		align-items: center;

		&--title {
			font-size: 28rpx;
			color: #252525;
		}

		&--position {
			font-size: 28rpx;
			color: #4367FD;
			cursor: pointer;
		}
	}

	&__detail {
		display: flex;
		align-items: center;
		margin-top: 20rpx;

		&--icon {
			width: 40rpx;
			height: 40rpx;
			margin-right: 8rpx;
		}

		&--location {
			font-size: 32rpx;
			color: #252525;
		}
	}

	&__rescue {
		padding: 28rpx 30rpx 0rpx 30rpx;

		&--operate {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		&-team {
			display: flex;
			align-items: center;

			&--name {
				color: #666666;
				font-size: 32rpx;
			}

			&--phone {
				color: #4367FD;
				font-weight: bold;
				font-size: 36rpx;
				margin-left: 20rpx;
			}
		}

		&--icon {
			display: flex;
			align-items: center;

			&-video {
				width: 66rpx;
				height: 66rpx;
				margin-right: 40rpx;
				cursor: pointer;
			}

			&-phone {
				width: 66rpx;
				height: 66rpx;
				margin-right: 14rpx;
				cursor: pointer;
			}
		}

		&--btn {
			display: flex;
			justify-content: center;
			align-items: center;
			margin-top: 52rpx;
			background: #4367FD;
			border-radius: 46rpx;
			height: 92rpx;
			font-size: 32rpx;
			color: #FFFFFF;
		}
	}

	.topTip {
		box-sizing: border-box;
		position: fixed;
		top: 0;
		left: 0;
		background: #fff;
		width: 100%;
		margin: 20rpx 16rpx;

		.topTipFlex {
			display: flex;
			padding-top: 18rpx;
			border-bottom: 2rpx solid #F1F1F1;

			.topTipLeft {
				margin: 0 26rpx 22rpx 34rpx;
				width: 180rpx;
				height: 180rpx;
				background: url("@/static/images/resuce/rescue-loding-background.png") no-repeat;
				background-size: cover;
				position: relative;

				.icon {
					width: 160rpx;
					height: 160rpx;
					position: absolute;
					top: 0;
					bottom: 0;
					left: 0;
					right: 0;
					margin: auto;
					animation: rotation 2s linear infinite;
				}

				@keyframes rotation {
					0% {
						transform: rotate(0deg);
					}

					100% {
						transform: rotate(360deg);
					}
				}

				.time {
					display: inline-block;
					width: 180rpx;
					height: 180rpx;
					text-align: center;
					line-height: 180rpx;
					color: rgb(93, 105, 125);
					font-size: 32rpx;
				}
			}

			.topTipRight {
				.topBox {
					height: 58rpx;
					line-height: 58rpx;
					font-size: 40rpx;
					font-weight: bold;
					color: #252525;
				}

				.botBox {
					display: flex;
					margin-top: 30rpx;

					.icon {
						width: 60rpx;
						height: 60rpx;
						margin-right: 12rpx;
					}

					view {
						height: 60rpx;
						line-height: 60rpx;
						color: #666666;
						font-size: 28rpx;
						margin-right: 52rpx;
					}

				}
			}
		}

		.topTipBtn {
			height: 88rpx;
			line-height: 88rpx;
			color: #4367FD;
			font-size: 32rpx;
			text-align: center;
		}

	}

	.botTip {
		box-sizing: border-box;
		position: fixed;
		bottom: 0;
		left: 0;
		width: 100%;
		background: #FFFFFF;
		box-shadow: 0rpx 0rpx 16rpx 2rpx rgba(67, 103, 253, 0.08);
		border-radius: 32rpx 32rpx 0rpx 0rpx;
		padding: 42rpx 34rpx 25rpx 38rpx;

		/* #ifdef H5 */
		.botTip {
			box-sizing: border-box;
			position: fixed;
			bottom: 100rpx;
			left: 0;
			width: 100%;
			background: #FFFFFF;
			box-shadow: 0rpx 0rpx 16rpx 2rpx rgba(67, 103, 253, 0.08);
			border-radius: 32rpx 32rpx 0rpx 0rpx;
			padding: 42rpx 34rpx 25rpx 38rpx;
		}

		/* #endif */
		.botTipTitle {
			display: flex;
			justify-content: space-between;
			align-items: center;

			.titleLeft {
				height: 60rpx;
				line-height: 60rpx;
				font-size: 40rpx;
				font-weight: bold;
				color: #252525;
			}

			.titleRight {
				font-size: 36rpx;
				color: #666666;

				text {
					color: #4367FD;
				}
			}
		}

		.botTipList {
			position: relative;

			.label {
				height: 66rpx;
				line-height: 66rpx;
				font-size: 32rpx;
				color: #666666;
				margin-right: 32rpx;
			}

			.name {
				height: 66rpx;
				line-height: 66rpx;
				font-size: 36rpx;
				color: #111111;
			}

			.phone {
				margin-left: 16rpx;
				color: #4367FD;
				font-size: 36rpx;
			}

			.icon {
				width: 60rpx;
				height: 60rpx;
				vertical-align: middle;
				position: absolute;
				top: 0;
				right: 0;
			}
		}
	}
}</style>
```



## 请求头签名

- `npm i -S CryptoJS`

```js
// utils.js
import CryptoJS from "crypto-js";

// 获取签名
export function generateSignature(method, uri, query, secretKey) {
    uri = uri.replace('/highway-applet/api','/highway-applet//api')//暂时
    const message = method + uri + (query ? '?' + query : '') + secretKey;
    const hash = CryptoJS.SHA256(message);
    const signature = CryptoJS.enc.Base64.stringify(hash);
    return signature;
}
```



## uniapp封装请求

```js
// request/index.js
import { generateSignature } from '../common/utils.js'

let ajaxNum = 0;
export const request = (params) => {
    if (params.method.toUpperCase() === 'PUT') {
        uni.showToast({
            title: '保存成功',
            icon: 'success',
            mask: true,
        });
    } else {
        uni.showLoading({
            title: '加载中',
            mask: true,
        });
    }
    // 不加loading（轮询的时候）
    if(params.isLoading){
        uni.hideLoading();
    }else{
        // uni.showLoading({
        //     title: '加载中',
        //     mask: true,
        // });
    }


	// 设置请求头签名
	let header = {}
	if (params.url === '/highway-applet/api/login/wxLogin' || params.url === '/highway-applet/api/login/getAuthorization' || params.url.includes('/highway-applet/api/login/getCusInfoByMinaId')) {
		header = undefined
	} else {
        // 获取接口对应的签名
        let signature = ''
        if (params.url.includes('?')) {
            signature = generateSignature(params.method.toUpperCase(), params.url.split('?')[0], params.url.split('?')[1], 'Gsgl@2023-!')
        } else {
            signature = generateSignature(params.method.toUpperCase(), params.url, '', 'Gsgl@2023-!')
        }
		header = {
			'X-Signature': signature
		}
	}

    ajaxNum++;
    // http://10.91.123.31:8086
    const baseUrl = process.env.NODE_ENV === 'development' ? 'https://gaosudanao.gci-china.com' : 'https://gaosudanao.gci-china.com'
    return new Promise((resolve, reject)=>{
        uni.request({
            ...params,
			header,
            url: baseUrl+params.url,
            success: (result) => {
                ajaxNum--;
                if (result.data.code === 500) {
                    uni.showToast({
                        title: result.data.message,
                        icon: 'error',
                        mask: true
                    });
                }
                resolve(result)
            },
            fail: (err) => {
                reject(err)
            },
            complete: () => {
                if(ajaxNum === 0){
                    if (params.method.toUpperCase() === 'PUT') {
                        // uni.hideToast();
                    } else {
                        uni.hideLoading();
                    }
                }
            }
        });

    })
}
```



## xm-keyboard

支持Vue3的车牌键盘

```js
<view class="xm-box" :class="showKeyBoard ? 'show':''" @tap="toShow">
    <view class="xm-input" :class="plateNumber.length === index ? 'cur':''" v-for="(item, index) in 8" :key="index">
        {{ plateNumber.charAt(index) }}
    </view>
</view>
<xm-keyboard v-model="showKeyBoard" maxAutoClose :show="showKeyBoard" :mask="false" @change="data => changeValue(data)" :maxLength="8" :defaultValue="plateNumber" :mode="keyMode" @close="e => closeShow(e)"></xm-keyboard>

let showKeyBoard = ref(false)
let keyMode = computed(() => {
	let length = plateNumber.value.length;
	if(length == 0) return 0;
	return 1
})
const toShow = () => {
	showKeyBoard.value = true
	isFocus.value = true
}
const changeValue = (data) => {
	plateNumber.value = data.text 
}

.xm-box{
	display: flex;
	justify-content: space-between;
	margin-left: 52rpx;
	
	&.show{
		.cur {
			border-color: #4367FD;
			
			@keyframes blink{
				0%{
					opacity: 0;
				}
				50%{
					opacity: 1;
				}
				100%{
					opacity: 0;
				}
			}
			&::after{
				color: #4367FD;
				content: '|';
				animation: blink 1s infinite;
			}
		}
	}
	
	.xm-input{
		margin-right: 20rpx;
		border: 2rpx solid #ADADAD;
		border-radius: 5rpx;
		width: 48rpx;
		height: 48rpx;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 36rpx;
	}
}
```



## 代码格式化

```js
// .prettierrc
{
  "semi": false,
  "singleQuote": true,
  "trailingComma": "none"
}
// .eslintrc.js
rules: {
    'no-console.log': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'no-debugger': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'indent': 0,
    'space-before-function-paren': 0
}
```